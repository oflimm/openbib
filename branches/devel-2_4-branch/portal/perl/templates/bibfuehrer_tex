\documentclass[version=,11pt, twoside, a4paper, BCOR8mm, DIV12, bibtotoc,idxtotoc]{scrbook}
\usepackage{german}
\usepackage{typearea}
\usepackage{longtable}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{url}
\usepackage[utf8]{inputenc}

% Zusaetzliche Picture-Umgebungen (z.B. shadowenv)
\usepackage{picins}

% Header anpassbar
\usepackage{fancyhdr}

% Headings umdefinieren
\pagestyle{fancy}
\fancyhf{}
\fancyhead[RO]{\nouppercase{\rightmark}}
\fancyhead[LE]{\nouppercase{\leftmark}}
\fancyfoot[RO, LE]{\thepage}

%\addtolength{\headwidth}{\marginparsep}
%\addtolength{\headwidth}{\marginparwidth}
\addtolength{\headwidth}{2cm}

\parindent0.0mm
\parskip0.3cm
\parindent=0pt\relax
\typearea{15}
\setcounter{secnumdepth}{0}
%\renewcommand\thesection{\arabic{section}.}
%\renewcommand\thesubsection{\thesection\arabic{subsection}.}

\renewcommand\arraystretch{1.3}% (1.0 is for standard spacing)

\begin{document}

\frontmatter
\begin{titlepage}

\begin{center}

\vspace{2cm}

  \textbf{\fontfamily{cmss}\fontseries{bx}\fontshape{n}\fontsize{60}{60pt}\selectfont Die Bibliotheken}\\[0.3cm]\textbf{\fontfamily{cmss}\fontseries{bx}\fontshape{n}\fontsize{30}{30pt}\selectfont der\\[0.6cm]Universit"at zu K"oln}

\vspace{2cm}

\includegraphics[width=12cm]{blaues-siegel-uni-koeln.jpg}

  \vspace{1cm}

  \textbf{\fontfamily{cmss}\fontseries{bx}\fontshape{n}\fontsize{14}{14pt}\selectfont Stand: \today}

\end{center}

\vspace{2mm}
\rule[-.1in]{18cm}{0.1mm}\\[2mm]
\begin{tabular}{lp{8cm}}
\raisebox{-0.6cm}{\includegraphics[width=3.2cm]{usblogo.jpg}} &
\raisebox{-0.1cm}{\textbf{\fontfamily{cmss}\fontseries{bx}\fontshape{n}\fontsize{14}{14pt}\selectfont
Ein Service der Abt. Universit"atsGesamtKatalog / USB K"oln}}\\
\end{tabular}

\rule[1cm]{18cm}{0.1mm}


\newpage 

Sehr geehrte Damen und Herren,

mit dem Bibliotheksf"uhrer des Jahres 2005 wurde die Publikation einer
Print-Ausgabe eingestellt und die Informationen zu den Bibliotheken
der Universit"at zu K"oln nur noch online auf den Webseiten angeboten.

Da jedoch weiterhin ein gro"ser Bedarf nach einer umfassenden "Ubersicht
aller Bibliotheken in einer ausdruckbaren Publikation besteht, bieten
wir nun einen automatisch aus den Webseiten generierten neuen
Bibliotheksf"uhrer an.

\minisec{URL des elektronischen Bibliotheksf"uhrers}

Unter dem URL \texttt{http://kug.ub.uni-koeln.de/bibliotheksfuehrer/} finden
Sie fortan den neuen elektronischen Bibliotheksf"uhrer.

\minisec{Angabe der ISIL}

Zur Identifizierung der einzelnen Bibliotheken wurden bislang immer
die jeweiligen Bibliothekssigel verwendet. Im Jahr 2007 hat die AG Verbundsysteme
beschlossen zuk"unftig auf Sigel zu verzichten und fortan nur noch die
ISIL (International Standard Identifier for Libraries and Related
Organizations) zu verwenden. Die ISIL setzt die bisherige
Sigelbezeichnung in einen internationalen Kontext und ist f"ur die
Kennzeichnung im Internet besser geeignet.

Aus dem bisherigen Sigel 38/006 wird z.B. die ISIL DE-38-006. Teile
des Sigels werden also sehr einfach in die ISIL "uberf"uhrt.

\minisec{Anzahl Monographien und Zeitschriften }

F"ur die dezentralen Bibliotheken werden die Angaben zur Anzahl an
Monographien, Zeitschriften und laufenden Zeitschriften kummuliert
f"ur alle zusammen sowie nach Fakult"at ausgegeben.

\vspace{1cm}

  \begin{tabular}[t]{ll}
    AnsprechpartnerInnen : & Abt. Universit"atsGesamtKatalog / USB K"oln\\
    Telefon : & 0221-470 3306 \\
    Fax     : & 0221-470 5166 \\
    E-Mail  : & gk@ub.uni-koeln.de \\
  \end{tabular}

\end{titlepage}

[%-
  zentrale_pools = [
                    "inst001",
                    "zbmed"
                   ];

  dez_orgunits = [
                   { 
                     desc = "Fakult\"atsungebundene Bibliotheken",
                     id   = 7,
                     image = "logounikoeln.jpg",
                   },
                   { 
                     desc = "Bibliotheken der Wirtschafts- und Sozialwissenschaftlichen Fakult\"at",
                     id   = 1,
                     image = "logowiso.jpg",
                   },
                   {                       
                     desc = "Bibliotheken der Rechtswissenschaftlichen Fakult\"at",
                     id   = 2,
                     image = "logorecht.jpg",
                   },
                   { 
                     desc = "Bibliotheken der Humanwissenschaftlichen Fakult\"at",
                     id   = 3,
                   },
                   { 
                     desc = "Bibliotheken der Philosophischen Fakult\"at",
                     id   = 4,
                     image = "logophil.jpg",
                   },
                   { 
                     desc = "Bibliotheken der Mathematisch-Naturwissenschaftlichen Fakult\"at",
                     id   = 5,
                     image = "logomatnat.jpg",
                   },
                   { 
                     desc = "Theologie als Studienfach",
                     id   = 6,
                   }
               ];

     dez_orgunit_pools = {

                     "7" = [
                     "inst005",
                     "inst006",
                     "inst007",
                     "inst008",
                     ],

                     "1" = [
                     "inst102",
                     "inst103",
                     "inst104",
                     "inst105",
                     "inst106",
                     "inst107",
                     "inst108",
                     "inst109",
                     "inst110",
                     "inst112",
                     "inst113",
                     "inst117",
                     "inst118",
                     "inst119",
                     "inst120",
                     "inst121",
                     "inst123",
                     "inst124",
                     "inst125",
                     "inst128",
                     "inst132",
                     "inst134",
                     "inst136",
                     "inst137",
                     "inst139",
                     "inst140",
                     "inst146",
                     "inst155",
                     "inst156",
                     "inst157",
                     "inst158",
                     "inst159",
                     "inst160",
                     "inst164",
                     "inst166",
                     "inst171",
                         ],
                  "2" = [
                     "inst201",
                     "inst203",
                     "inst204",
                     "inst205",
                     "inst206",
                     "inst207",
                     "inst208",
                     "inst209",
                     "inst210",
                     "inst211",
                     "inst212",
                     "inst213",
                     "inst214",
                     "inst215",
                     "inst216",
                     "inst217",
                     "inst218",
                     "inst219",
                     "inst220",
                     "inst221",
                     "inst222",
                     "inst223",
                     "inst224",
                     "inst225",
                     "inst226",
                     "inst227",
                     "inst228",
                     "inst230",
                     "inst231",
                     "inst232",
                     "inst233",
                     "inst234",
                      ],
                  "3" = [
                     "inst302",
                     "inst303",
                     "inst304",
                     "inst305",
                     "inst308",
                     "inst309",
                     "inst310",
                     "inst319",
                     "inst320",
                     "inst321",
                     "inst326",
                     "inst327",
                     "inst403",
                      ],
                  "4" = [
                     "inst401",
                     "inst404",
                     "inst405",
                     "inst406",
                     "inst407",
                     "inst408",
                     "inst409",
                     "inst410",
                     "inst411",
                     "inst412",
                     "inst413",
                     "inst416",
                     "inst418",
                     "inst419",
                     "inst420",
                     "inst421",
                     "inst422",
                     "inst423",
                     "inst425",
                     "inst426",
                     "inst427",
                     "inst428",
                     "inst429",
                     "inst430",
                     "inst431",
                     "inst432",
                     "inst433",
                     "inst434",
                     "inst437",
                     "inst438",
                     "inst444",
                     "inst445",
                     "inst448",
                     "inst460",
                     "inst461",
                     "inst462",
                     "inst463",
                     "inst464",
                     "inst465",
                     "inst466",
                     "inst467",
                      ],
                  "5" = [
                     "inst501",
                     "inst502",
                     "inst503",
                     "inst509",
                     "inst514",
                     "inst517",
                     "inst519",
                     "inst525",
                     "inst526",
                     "inst540",
                      ],
                  "6" = [
                     "inst622",
                     "inst623",
                      ],
                    };

            categories = [
                'I0010', # msg.maketext("I0010") # Institutsname
                'I0020', # msg.maketext("I0020") # Straße
                'I0030', # msg.maketext("I0030") # Gebäude
#                'I0040', # msg.maketext("I0040") # Interaktiver Lageplan der Universität
                'I0050', # msg.maketext("I0050") # Gemeinsame Bibliothek
                'I0060', # msg.maketext("I0060") # Telefon
                'I0070', # msg.maketext("I0070") # Fax
                'I0080', # msg.maketext("I0080") # E-Mail
                'I0090', # msg.maketext("I0090") # Internet
                'I0100', # msg.maketext("I0100") # Auskunft / Bibliothekar(in)
                'I0110', # msg.maketext("I0110") # Öffnungszeiten
                'I0120', # msg.maketext("I0120") # Bestand Monos
                'I0130', # msg.maketext("I0130") # Bestand Zeitschriften
                'I0140', # msg.maketext("I0140") # Anzahl laufender Zeitschriften
                'I0150', # msg.maketext("I0150") # Bestand CD's / Digitale Medien
                'I0160', # msg.maketext("I0160") # Sonstige Bestandsangaben
                'I0170', # msg.maketext("I0170") # Besondere Sammelgebiete
                'I0180', # msg.maketext("I0180") # Art der Bibliothek
                'I0190', # msg.maketext("I0190") # Neuerwerbungslisten
                'I1000', # msg.maketext("I1000") # Geo-Koordinaten
               ];
-%]


%\thispagestyle{empty}

%\begin{verbatim}


%Copyright (c) 2005 Oliver Flimm <flimm@openbib.org>

%Es wird die Erlaubnis gegeben dieses Dokument zu kopieren, verteilen 
%und/oder zu veraendern unter den Bedingungen der GNU Free
%Documentation License, Version 1.1 oder einer spaeteren, von der Free 
%Software Foundation veroeffentlichten Version; mit den
%Unveraenderlichen Abschnitten DEREN TITEL AUFGEZAEHLT sind, mit den 
%Vorderseitentexten die AUFGEZAEHLT sind, und mit den Rueckseitentexten
%die AUFGEZAEHLT sind. Eine Kopie dieser Lizenz ist in dem Abschnitt 
%enthalten, der mit "GNU Free Documentation License"
%\end{verbatim}

\mainmatter

\tableofcontents

\chapter{Zentrale Hochschulbibliotheken}

[%   FOREACH database IN zentrale_pools %]

[%   NEXT IF NOT config.have_libinfo(database) %]

[% dbinfo  = config.get_dbinfo(database) %]
[% libinfo = config.get_libinfo(database) %]
[% truncdesc = libinfo.${"I0010"}.first.content | truncate(65) %]

%\subsection{[% filterchars(libinfo.${"I0010"}.first.content) %]}
\section[[% IF dbinfo.sigel.match("^[0-9][0-9]") %]ISIL DE-[% dbinfo.sigel.replace(" ","") %][% ELSE %][% dbinfo.sigel %][% END %] : [% filterchars(truncdesc,1) %]]{[% IF dbinfo.sigel.match("^[0-9][0-9]") %]ISIL DE-[% dbinfo.sigel %][% ELSE %][% dbinfo.sigel %][% END %] : [% filterchars(libinfo.${"I0010"}.first.content,1) %]}

\subsubsection*{Informationen zur Bibliothek}
\begin{tabular}{p{5.5cm}|p{11cm}}
%\begin{description}
[% FOREACH category IN categories;
      FOREACH item IN libinfo.$category;
        content = item.content.replace("^ ","");
        NEXT IF content == "0" ;

        # Nachgeschaltete datenbankspezifische Kategorienamen-Mappings sind
        # in Config.pm fuer die entsprechende Datenbank definiert
        # und werden im Message-Katalog als <Kategorie>-<Datenbankname>
        # kodiert.
        thiscategory = category ;
        IF config.get('categorymapping').${libinfo.database}.$category ;
          thiscategory = "${category}-${database}" ;
        END;
%]
  \textbf{[% filterchars(msg.maketext("${thiscategory}")) %]} & \noindent [% filterchars(item.content) %]\\
%\item[[% filterchars(msg.maketext("${thiscategory}")) %]] [% filterchars(item.content) %]
[%   END %]
[%   END %]
\end{tabular}
%\end{description}

\newpage
[% IF libinfo.${"I1000"}.first.content %]
\subsubsection*{Lageplan der Bibliothek}

\begin{shadowenv}
\begin{center}
\includegraphics[width=15cm]{[% libinfo.${"I1000"}.first.content.replace('\s*,\s*','-').replace('\.','_') %]_map.png}
\end{center}
\end{shadowenv}

\newpage
[% END %]
[% END %]


\chapter{Dezentrale Hochschulbibliotheken}

[%

all_dezmonoanz    = 0;
all_dezzeitanz    = 0;
all_dezlfdzeitanz = 0;
all_dezonlineanz  = 0;
all_dezbiblanz    = 0;

FOREACH orgunit IN dez_orgunits ;

  monoanz          = 0;
  zeitanz          = 0;
  lfdzeitanz       = 0;
  onlineanz        = 0;
  biblanz          = 0;

  FOREACH database IN dez_orgunit_pools.${orgunit.id} ;
     onlinetitcount = config.get_number_of_titles(database => database);
     libinfo        = config.get_libinfo(database);

     monoanz          = monoanz + libinfo.${"I0120"}.first.content.replace('\D','');
     zeitanz          = zeitanz + libinfo.${"I0130"}.first.content.replace('\D','');
     lfdzeitanz       = lfdzeitanz + libinfo.${"I0140"}.first.content.replace('\D','');
     onlineanz        = onlineanz + onlinetitcount.all;
     biblanz          = biblanz + 1;

     all_dezmonoanz    = all_dezmonoanz + libinfo.${"I0120"}.first.content.replace('\D','');
     all_dezzeitanz    = all_dezzeitanz + libinfo.${"I0130"}.first.content.replace('\D','');
     all_dezlfdzeitanz = all_dezlfdzeitanz + libinfo.${"I0140"}.first.content.replace('\D','');
     all_dezonlineanz  = all_dezonlineanz + onlinetitcount.all;
-%]
% [% database %] - Monos [% libinfo.${"I0120"}.first.content.replace('\D','') %] - Online [% onlinetitcount.all %]
[%

  END;

  anzahl.${orgunit.id}.mono    = monoanz;
  anzahl.${orgunit.id}.zeit    = zeitanz;
  anzahl.${orgunit.id}.lfdzeit = lfdzeitanz;
  anzahl.${orgunit.id}.online  = onlineanz;
  anzahl.${orgunit.id}.bibl    = biblanz;

  all_dezbiblanz   = all_dezbiblanz + biblanz;

END;

-%]

[%# USE dumper; dumper.dump(anzahl)%]
\begin{center}
\begin{shadowenv}
\begin{tabular}{ll}
\textbf{Anzahl Bibliotheken} & [% all_dezbiblanz %]\\
&\\
\textbf{Anzahl Medien}       & \\
\emph{B"ucher} & [% all_dezmonoanz %]\\
\emph{Zeitschriften} & [% all_dezzeitanz %]\\
\emph{Lfd. Zeitschriften} & [% all_dezlfdzeitanz %]\\
\textbf{Anzahl online recherchierbare Titel} & [% all_dezonlineanz %]\\
\end{tabular}
\end{shadowenv}
\end{center}

\newpage

[% FOREACH orgunit IN dez_orgunits %]

\section{[% orgunit.desc %]}

[% IF orgunit.image %]
\vspace{2cm}

\begin{center}
\includegraphics[height=12cm]{[% orgunit.image %]}
\end{center}

\vspace{1cm}
[% END %]

\begin{center}
\begin{shadowenv}
\begin{tabular}{ll}
\textbf{Anzahl Bibliotheken} & [% anzahl.${orgunit.id}.bibl %]\\
&\\
\textbf{Anzahl Medien}       & \\
\emph{B"ucher} & [% anzahl.${orgunit.id}.mono %]\\
\emph{Zeitschriften} & [% anzahl.${orgunit.id}.zeit %]\\
\emph{Lfd. Zeitschriften} & [% anzahl.${orgunit.id}.lfdzeit %]\\
\textbf{Anzahl online recherchierbare Titel} & [% anzahl.${orgunit.id}.online %]\\
\end{tabular}
\end{shadowenv}
\end{center}

\newpage

[%   FOREACH database IN dez_orgunit_pools.${orgunit.id} %]

[% dbinfo  = config.get_dbinfo(database) %]
[% libinfo = config.get_libinfo(database) %]
[% truncdesc = libinfo.${"I0010"}.first.content | truncate(65) %]

[%   NEXT IF NOT config.have_libinfo(database) %]


[%# USE dumper;dumper.dump(dbinfo) %]

[%# USE dumper;dumper.dump(libinfo) %]

%\subsection{[% filterchars(libinfo.${"I0010"}.first.content) %]}
\subsection[[% IF dbinfo.sigel.match("^[0-9][0-9][0-9]") %]ISIL DE-38-[% dbinfo.sigel %][% ELSE %][% dbinfo.sigel %][% END %] : [% filterchars(truncdesc) %]]{[% IF dbinfo.sigel.match("^[0-9][0-9][0-9]") %]ISIL DE-38-[% dbinfo.sigel %][% ELSE %][% dbinfo.sigel %][% END %] : [% filterchars(libinfo.${"I0010"}.first.content) %]}

\subsubsection*{Informationen zur Bibliothek}
\begin{tabular}{p{5.5cm}|p{11cm}}
%\begin{description}
[% FOREACH category IN categories;
      FOREACH item IN libinfo.$category;
        content = item.content.replace("^ ","");
        NEXT IF content == "0" ;

        # Nachgeschaltete datenbankspezifische Kategorienamen-Mappings sind
        # in Config.pm fuer die entsprechende Datenbank definiert
        # und werden im Message-Katalog als <Kategorie>-<Datenbankname>
        # kodiert.
        thiscategory = category ;
        IF config.get('categorymapping').${libinfo.database}.$category ;
          thiscategory = "${category}-${database}" ;
        END;
%]
  \textbf{[% filterchars(msg.maketext("${thiscategory}")) %]} & \noindent [% filterchars(item.content) %]\\
%\item[[% filterchars(msg.maketext("${thiscategory}")) %]] [% filterchars(item.content) %]
[%   END %]
[%   END %]
\end{tabular}
%\end{description}

\newpage
[% IF libinfo.${"I1000"}.first.content %]
\subsubsection*{Lageplan der Bibliothek}

\begin{shadowenv}
\begin{center}
\includegraphics[width=15cm]{[% libinfo.${"I1000"}.first.content.replace('\s*,\s*','-').replace('\.','_') %]_map.png}
\end{center}
\end{shadowenv}

\newpage
[% END %]
[%   END %]

[%   END %]

\end{document}
