<?xml version="1.0" encoding="utf-8"?>
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:mods="http://www.loc.gov/mods/v3" version="3.7"
    xsi:schemaLocation="http://www.loc.gov/mods/v3 http://www.loc.gov/standards/mods/v3/mods-3-7.xsd">
    [%- title_exists = 0 %]
    [%- normdata = record.get_fields -%]
        [%- FOREACH key IN normdata.keys -%]
            [%- IF normdata.$key.size %]
            [%- title_exists = 1 %]
            [%- END %]
        [%- END %]
    [%- IF title_exists -%]
    <record>
        <mods:mods>
            [%- IF normdata.${"T0662"} %]
            [%- FOREACH url IN normdata.${"T0662"} -%]
            [%- IF url.content.match('http://www.ub.uni-koeln.de/permalink/') %]
            <mods:identifier type="purl">[%url.content%]</mods:identifier>
            [%- ELSE %]
            <mods:identifier type="purl">-</mods:identifier>
            [%- END -%]
            [%- END -%]
            [%- END -%]
            [%- IF normdata.${"T0578"} %]
            <mods:identifier type="fingerprint">[%- normdata.${"T0578"}.first.content %]</mods:identifier>
            [%- END -%]
            [%- IF normdata.${"T0580"} %]
            [%- FOREACH number IN normdata.${"T0580"} -%]
            [%- IF number.content.match('VD16') %]
            <mods:identifier type="vd16">[%- number.content%]</mods:identifier>
            [%- ELSIF number.content.match('VD17') %]
            <mods:identifier type="vd17">[%- number.content%]</mods:identifier>
            [%- ELSIF number.content.match('VD18') %]
            <mods:identifier type="vd18">[%- number.content%]</mods:identifier>
            [%- END -%]
            [%- END -%]
            [%- END -%]
            [%- IF normdata.${"T1024"} %]
            [%- FOREACH number IN normdata.${"T1024"} -%]
            [%- IF number.content.match('ZDB') %]
            <mods:identifier type="zdb">[%- number.content.replace('ZDB', '')%]</mods:identifier>
            [%- END -%]
            [%- END -%]
            [%- END -%]
            [%- IF normdata.${"T0010"} %]
            <mods:identifier type="HBZ">[% normdata.${"T0010"}.first.content -%]</mods:identifier>
            [%- END -%]
            [%-
            IF normdata.${"T5005"}.first;
            super = from_json(normdata.${"T5005"}.first.content);
            all_super = normdata.${"T5005"};
            END; %]
            [%- FOREACH super_item IN all_super %]
            [%- super_data = from_json(super_item.content);%]
            [%- IF loop.first && (super_data.fields.${'0036'}.first.content =="n" ||
            super_data.fields.${'0036'}.first.content =="p"
            || super_data.fields.${'0036'}.first.content =="z" || super_data.fields.${'0036'}.first.content =="t") &&
            (normdata.${"T0090"} || normdata.${"T0089"}) %]
            <mods:identifier type="HBZ_UEB_HOST">[% super_data.fields.${'0010'}.first.content -%]</mods:identifier>
            [%- ELSE -%]
            <mods:identifier type="HBZ_UEB">[% super_data.fields.${'0010'}.first.content -%]</mods:identifier>
            [%- END -%]
            [%- END -%]
            <mods:recordInfo>
                <mods:recordIdentifier source="DE-38">[% record.id %]</mods:recordIdentifier>
            </mods:recordInfo>
            [%- IF personlist && personlist.size -%]
            [%- FOREACH item IN personlist %]
            <mods:name type="personal" [%- IF item.gnd -%] authority="gnd" authorityURI="http://d-nb.info/gnd/"
                valueURI="http://d-nb.info/gnd/[% item.gnd %]" [%END%]>
                [%- IF item.namedata.family_name %]
                <mods:namePart type="family">[% item.namedata.family_name %]</mods:namePart>
                [%- END %]
                <mods:namePart type="given">[% item.namedata.given_name %]</mods:namePart>
                [%- IF item.namedata.termsOfAddress %]
                <mods:namePart type="termsOfAddress">[% item.namedata.termsOfAddress %]</mods:namePart>
                [%- END %]
                <mods:displayForm>[% item.namedata.displayname %]</mods:displayForm>
                <mods:role>
                    [%- IF item.field == "T0100" %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/aut">aut</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Urheb') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/aut">aut</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Hrsg') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/edt">edt</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Übers') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/trl">trl</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Bearb') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/edt">edt</mods:roleTerm>
                    [%- ELSE %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/oth">oth</mods:roleTerm>
                    [%- IF item.supplement %]
                    <mods:roleTerm type="text">[%- item.supplement | replace('¬', '') %]</mods:roleTerm>
                    [%- END %]
                    [%- END %]
                </mods:role>
            </mods:name>
            [%- END -%]
            [%- END -%]
            [%- IF corporation_list && corporation_list.size %]
            [%- FOREACH item IN corporation_list %]
            <mods:name type="corporate" [%- IF item.gnd -%] authority="gnd" authorityURI="http://d-nb.info/gnd/"
                valueURI="http://d-nb.info/gnd/[% item.gnd %]" [%END%]>
                <mods:namePart>[% item.namedata %]</mods:namePart>
                <mods:role>
                    [%- IF item.field == "T0200" %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/aut">aut</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Hrsg') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/edt">edt</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Übers') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/trl">trl</mods:roleTerm>
                    [%- ELSIF item.supplement.match('Bearb') %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/edt">edt</mods:roleTerm>
                    [%- ELSE %]
                    <mods:roleTerm type="code" authority="marcrelator"
                        authorityURI="http://id.loc.gov/vocabulary/relators"
                        valueURI="http://id.loc.gov/vocabulary/relators/oth">oth</mods:roleTerm>
                    [%- IF item.supplement %]
                    <mods:roleTerm type="text">[%- item.supplement %] | replace('¬', '') %]</mods:roleTerm>
                    [%- END %]
                    [%- END %]
                </mods:role>
            </mods:name>
            [%- END -%]
            [%- END -%]
            [%- IF normdata.${"T0331"} %]
            <mods:titleInfo>
                <mods:title>[% normdata.${"T0331"}.first.content %]</mods:title>
            [%- FOREACH item IN normdata.${"T0335"} %]
            <mods:subTitle>[% item.content %]</mods:subTitle>
            [%- END %]
            </mods:titleInfo>
            [%- ELSIF normdata.${"T0089"} && super.fields.${'0331'}.first.content %]
            <mods:titleInfo>
                <mods:title>[%- super.fields.${"0331"}.first.content %] / [% normdata.${"T0089"}.first.content %]</mods:title>
            </mods:titleInfo>
            [%- END %]
            [%- IF title_list && title_list.size %]
            [%-FOREACH title IN title_list %]
            [%- IF title.field == "T0370" || title.field == "T0361" -%]
            <mods:titleInfo type="alternative">
                <mods:title>[% title.title %]</mods:title>
            </mods:titleInfo>
            [%- END %]
            [%- IF title.field == "T0341" %]
            <mods:titleInfo type="translated">
                <mods:title>[% title.title %]</mods:title>
            </mods:titleInfo>
            [%- END %]
            [%- IF title.field == "T0304" || title.field == "T0310" || title.field == "T7303" -%]
            <mods:titleInfo type="uniform" [%- IF title.gnd -%] authority="gnd" authorityURI="http://d-nb.info/gnd/"
                valueURI="http://d-nb.info/gnd/[% title.gnd %]" [%END%]>
                <mods:title>[% title.title %]</mods:title>
            </mods:titleInfo>
            [%- END %]
            [%- END %]
            [%- END %]
            <mods:originInfo eventType="publication">
                [%- IF place_list && place_list.size %]
                [%- FOREACH place IN place_list %]
                <mods:place>
                    [%- IF place.place_norm %]
                    <mods:placeTerm type="text" lang="deu">[% place.place_norm.place_name %]</mods:placeTerm>
                    [%- END %]
                    [%- IF place.place_free && place.place_free.place_name != place.place_norm.place_name %]
                    <mods:placeTerm type="text">[% place.place_free.place_name %]</mods:placeTerm>
                    [%- END %]
                </mods:place>
                [%- END %]
                [%- END %]
                [%- FOREACH item IN normdata.${"T0412"} %]
                <mods:publisher>[% item.content %]</mods:publisher>
                [%- END %]
                [%- type_is_set = "false" %]
                [%- IF (normdata.${"T0036"}.first.content =="m" || normdata.${"T0036"}.first.content =="s") && type_is_set == "false" %]
                <mods:issuance>monographic</mods:issuance>
                [%- type_is_set = "true" %]
                [%- END %]
                [%- IF (normdata.${"T0036"}.first.content == "p" || normdata.${"T0036"}.first.content =="z") &&
                type_is_set == 'false' %]
                <mods:issuance>serial</mods:issuance>
                [%- type_is_set = "true" %]
                [%- END %]
                [%- IF type_is_set == 'false' -%]
                [%- IF normdata.${"T0036"}.first.content =="n" || normdata.${"T0036"}.first.content =="t" %]
                <mods:issuance>multipart monograph</mods:issuance>
                [%- type_is_set = "true" %]
                [%- END %]
                [%- END %]
                [%- IF type_is_set == 'false' -%]
                [%- IF super.fields.${'0036'}.first.content == "t" || super.fields.${'0036'}.first.content == "n" %]
                <mods:issuance>single unit</mods:issuance>
                [%- type_is_set = "true" %]
                [%- END %]
                [%- END %]
                [%- IF date_values.start_date %]
                <mods:dateIssued keyDate="yes" encoding="iso8601" point="start">[%- date_values.start_date %]</mods:dateIssued>
                [%- END %]
                [%- IF date_values.end_date %]
                <mods:dateIssued encoding="iso8601" point="end">[% date_values.end_date %]</mods:dateIssued>
                [%- IF date_values.date_norm %]
                <mods:dateIssued>[%- date_values.date_norm %]</mods:dateIssued>
                [%- END %]
                [%- IF date_values.date %]
                <mods:dateIssued>[%- date_values.date%]</mods:dateIssued>
                [%- END %]
                [%- END %]
                [%- UNLESS date_values.start_date %]
                [%- IF date_values.date_norm %]
                <mods:dateIssued keyDate="yes" encoding="iso8601">[% date_values.date_norm%]</mods:dateIssued>
                [%- END %]
                [%- IF date_values.date %]
                <mods:dateIssued>[% date_values.date %]</mods:dateIssued>
                [%- END %]
                [%- END %]
                [%- IF normdata.${"T0405"} %]
                <mods:dateIssued>[%- normdata.${"T0405"}.first.content %]</mods:dateIssued>
                [%- END %]
                [%- IF normdata.${"T0403"} %]
                <mods:edition>[%- normdata.${"T0403"}.first.content %]</mods:edition>
                [%- END %]
            </mods:originInfo>
            [%- IF normdata.${"T0036"}.first.content == "p"%]
            <mods:genre>Zeitschrift</mods:genre>
            [%- ELSIF normdata.${"T0036"}.first.content == "z" %]
            <mods:genre>Zeitung</mods:genre>
            [%- ELSIF super.fields.${'0036'}.first.content == "p" && normdata.${"T0089"}.first.content %]
            <mods:genre>Zeitschriftenband</mods:genre>
            [%- ELSIF super.fields.${'0036'}.first.content == "z" && normdata.${"T0089"}.first.content %]
            <mods:genre>Zeitungsband</mods:genre>
            [%- END %]
            [%- IF normdata.${"T0015"} %]
            [%- FOREACH item IN normdata.${"T0015"} %]
            <mods:language>
                <mods:languageTerm type="code" authority="iso639-2b">[%- item.content %]</mods:languageTerm>
            </mods:language>
            [%-END%]
            [%- ELSIF normdata.${"T4301"} %]
            [%- FOREACH item IN normdata.${"T4301"} %]
            <mods:language>
                <mods:languageTerm type="code" authority="iso639-2b">[%- item.content %]</mods:languageTerm>
            </mods:language>            
            [%- END %]
            [%- END %]
            [%- IF normdata.${"T0433"} || normdata.${"T0435"} || normdata.${"T0434"} %]
            <mods:physicalDescription>
                [%- FOREACH extend IN normdata.${"T0433"} %]
                <mods:extent>[%- extend.content %]</mods:extent>
                [%-END%]
                [%- FOREACH extend IN normdata.${"T0434"} %]
                <mods:extent>[%- extend.content %]</mods:extent>
                [%-END%]
                [%- FOREACH extend IN normdata.${"T0435"} %]
                <mods:extent>[%- extend.content %]</mods:extent>
                [%-END%]
            </mods:physicalDescription>
            [%-END -%]
            [%-FOREACH provenance IN provenance_data -%]
            <mods:note type="ownership">signatur::[% provenance.prov_signatur %]|||beschreibung::[% provenance.prov_text
                %][%- IF provenance.prov_person %]|||person::[% provenance.prov_person %][%- END %][%- IF
                provenance.prov_corp %]|||corp::[% provenance.prov_corp %][%- END %][%- IF provenance.prov_gnd
                %]|||gnd::http://d-nb.info/gnd/[% provenance.prov_gnd %][%END%]</mods:note>
            [%- END %]
            [%- FOREACH uniform_publisher IN uniform_publisher_list %]
            [%- IF uniform_publisher.gnd -%]
            <mods:note type="statement of responsibility">Publisher||[%- uniform_publisher.publisher_name %][%- IF
                uniform_publisher.publisher_place %] ([%- uniform_publisher.publisher_place -%])[%- END
                %]||http://d-nb.info/gnd/[% uniform_publisher.gnd %]</mods:note>
            [%- END %]
            [%- END %]
            [%- FOREACH item IN normdata.${"T4700"} %]
            <mods:classification authority="DE-38">[% item.content %]</mods:classification>
            [%- END %]
            [%- IF normdata.${"T4718"}.first.content == "rheinland" %]
            <mods:classification authority="DE-38">Sammlung Rheinland</mods:classification>
            [%- END %]
            [%- rswk_list = {} %]
            [%- FOREACH rswk_item IN rswk_keyword_list %]
            [%- FOREACH item IN rswk_item %]
            [%- value = item.content %]
            [%- UNLESS rswk_list.$value == 'True' %]
            [%- rswk_list.$value = 'True' %]
            <mods:classification authority="RSWK">[% value %]</mods:classification>
            [%- END %]
            [%- END %]
            [%- END %]
            [%- IF normdata.${"T0710"} %]
            <mods:subject>
                [%- FOREACH item IN normdata.${"T0710"} %]
                <mods:topic>[% item.content %]</mods:topic>
                [%- END %]
            </mods:subject>
            [%- END %]
            [%- IF all_super %]
            [%- FOREACH super_item IN all_super %]
            [%- super_data = from_json(super_item.content);
            super_title = super_data.fields.${'0451'}.first.content;
            IF super_data.fields.${'0331'}.first.content;
            super_title = super_data.fields.${'0331'}.first.content;
            END;
            %]
            [%- IF super_data.fields.${'0036'}.first.content =="r" || normdata.${"T0036"} == "s" %]
            <mods:relatedItem type="series">
                <mods:recordInfo>
                        <mods:recordIdentifier source="DE-38">[%- super_data.id %]</mods:recordIdentifier>
                    </mods:recordInfo>
                    <mods:titleInfo>
                        <mods:title>[%- super_title %]</mods:title>
                    </mods:titleInfo>
                    [%- IF loop.first %]
                    [%- IF normdata.${"T0456"} %]
                    <mods:part order='[%- normdata.${"T0456"}.first.content %]'>
                    [%- ELSE %]
                    <mods:part order='[%- normdata.${"T0455"}.first.content %]'>
                    [%- END %]
                        <mods:detail type="volume">
                            <mods:number>[% normdata.${"T0455"}.first.content %]</mods:number>
                        </mods:detail>
                    </mods:part>
                    [%- END %]
            </mods:relatedItem>
            [%- ELSIF super_data.fields.${'0036'}.first.content =="n" || super_data.fields.${'0036'}.first.content =="p"
            || super_data.fields.${'0036'}.first.content =="z" || super_data.fields.${'0036'}.first.content =="t" %]
            <mods:relatedItem type="host">
                <mods:recordInfo>
                    <mods:recordIdentifier source="DE-38">[%- super_data.id %]</mods:recordIdentifier>
                </mods:recordInfo>
                <mods:titleInfo>
                    <mods:title>[%- super_title %]</mods:title>
                </mods:titleInfo>
            </mods:relatedItem>
            [%- IF loop.first %]
            [%- IF normdata.${"T0090"} || normdata.${"T0089"} %]
            <mods:part order='[%- normdata.${"T0024"}.first.content %]'>
                <mods:detail type="volume">
                [%- IF normdata.${"T0089"} %]
                    <mods:number>[% normdata.${"T0089"}.first.content %]</mods:number>
                [%- ELSIF normdata.${"T0455"} %]
                <mods:number>[% normdata.${"T0455"}.first.content %]</mods:number>
                [%- END %]
                </mods:detail>
            </mods:part>
            [%- END %]
            [%- END %]
            [%- END %]
            [%- END %]
            [%- END %]
                [%- IF contained_works && contained_works.size %]
                [%-FOREACH contained_work IN contained_works %]
                <mods:part type="constituent">
                    <mods:detail>
                        <mods:title>[%- IF contained_work.person %][%contained_work.person %]: [%-END%][%-contained_work.title %]</mods:title>
                    </mods:detail>
                </mods:part>
                [%- END %]
                [%- END %]
        </mods:mods>
    </record>
    [%- ELSE %]
    <error code="idDoesNotExist"></error>
    [%- END %]
</OAI-PMH>