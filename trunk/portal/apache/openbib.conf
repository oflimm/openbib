#####################################################################
#
#  openbib.conf
#
#  OpenBib-Konfiguration fuer einen mod_perl-basierten Apache Webserver
#
#  Dieses File ist (C) 2004-2012 Oliver Flimm <flimm@openbib.org>
#
#  Dieses Programm ist freie Software. Sie koennen es unter
#  den Bedingungen der GNU General Public License, wie von der
#  Free Software Foundation herausgegeben, weitergeben und/oder
#  modifizieren, entweder unter Version 2 der Lizenz oder (wenn
#  Sie es wuenschen) jeder spaeteren Version.
#
#  Die Veroeffentlichung dieses Programms erfolgt in der
#  Hoffnung, dass es Ihnen von Nutzen sein wird, aber OHNE JEDE
#  GEWAEHRLEISTUNG - sogar ohne die implizite Gewaehrleistung
#  der MARKTREIFE oder der EIGNUNG FUER EINEN BESTIMMTEN ZWECK.
#  Details finden Sie in der GNU General Public License.
#
#  Sie sollten eine Kopie der GNU General Public License zusammen
#  mit diesem Programm erhalten haben. Falls nicht, schreiben Sie
#  an die Free Software Foundation, Inc., 675 Mass Ave, Cambridge,
#  MA 02139, USA.
#
#####################################################################   

# Im Produktionsbetrieb Performance-Optimierung - dann PerlSetEnv kommentieren
# PerlSetupEnv Off

# Ein 'touch' auf openbib.reload sollen einen automatischen Reload
# aller OpenBib-Module im Apache Webserver nach sich ziehen

#PerlModule Apache2::Reload
#PerlInitHandler Apache2::Reload

#PerlSetVar ReloadAll       Off
#PerlSetVar ReloadTouchFile /tmp/openbib.reload

# DBI Debugging
#PerlSetEnv DBI_TRACE "3=/tmp/dbitrace.log"

# DBIC Debugging
#PerlSetEnv DBI_TRACE "3=/tmp/dbictrace.log"

# PerlSetEnv CGIAPP_DISPATCH_DEBUG "true"

# Profiling
#PerlModule Apache::DProf

<IfDefine NYTPROF>
   MaxClients 1
#   MaxRequestsPerChild 0
   PerlPassEnv NYTPROF
   PerlModule Devel::NYTProf::Apache
</IfDefine>

# PerlModule Apache2::porting

# GlobalRequest fuer Apache::Singleton und pnotes notwendig
<Location /portal>
  PerlOptions      +GlobalRequest +SetupEnv
  PerlAuthenHandler OpenBib::Handler::Apache::Authentication

  AuthType Basic
  AuthName "OpenBib Discovery Portal"
  Require valid-user
#  PerlFixupHandler Apache::DB
</Location>

PerlLoadModule Apache2::SizeLimit

<Perl>
use OpenBib::Config;

# Debugging
use APR::Pool ();
#$ENV{PERLDB_OPTS} = "NonStop=1 LineInfo=/tmp/db.out AutoTrace=1 frame=2";

#use Apache::DB ();
#Apache::DB->init();

use Log::Log4perl;

my $config = OpenBib::Config->instance;

#Log::Log4perl->init_once($config->{log4perl_path});
#Log::Log4perl->init_once("/var/log/openbib/portal.log");

# Debian Squeeze
#$Apache2::SizeLimit::MAX_PROCESS_SIZE  = 700000 ;
#$Apache2::SizeLimit::CHECK_EVERY_N_REQUESTS = 2;

# Kubuntu 11.10
Apache2::SizeLimit->set_max_process_size(1_500_000);   # Max size in KB
Apache2::SizeLimit->set_min_shared_size(10_000);     # Min share in KB
Apache2::SizeLimit->set_max_unshared_size(1_200_000);  # Max unshared size in KB
Apache2::SizeLimit->set_check_interval(2); 

# Preloading weiterer Module

use OpenBib::Schema::System;
use OpenBib::Schema::Statistics;
use OpenBib::Schema::Enrichment;
use OpenBib::Schema::Catalog;
use OpenBib::L10N;
use Cache::Memcached;
use APR::URI            ();
use Apache2::Connection ();
use Apache2::Const -compile => qw(:common);
use Apache2::Log        ();
use Apache2::Request    ();
use Apache2::RequestIO  ();
use Apache2::RequestRec ();
use Apache2::SubRequest ();
use Apache2::URI        ();
use DBI                 ();
use Digest::MD5         ();
use Email::Valid        ();
use HTTP::Request       ();
use HTTP::Response      ();
use IO::Socket          ();
use LWP::UserAgent      ();
use MIME::Lite          ();
use POSIX               ();
use SOAP::Lite          ();
use Socket              ();
use Template            ();
use OpenBib::Handler::Apache::Dispatch;

DBI->install_driver("Pg");

$Location{"$config->{base_loc}"} = {
#        PerlFixupHandler => 'OpenBib::Handler::Apache::Dispatch',
        SetHandler => modperl,
#        SetHandler => perl-script,
        PerlResponseHandler => OpenBib::Handler::Apache::Dispatch,
};

</Perl>

# Vorsichtsmassnahme gegen amoklaufende Apache-Prozesse
PerlCleanupHandler Apache2::SizeLimit
