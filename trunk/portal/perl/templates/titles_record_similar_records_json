[%-

similar_records_output = [];

FOREACH similar_record IN similar_records.sort({order = 'asc', type = 'title'}).get_records ;
  item = similar_record.get_fields ;
  item.delete('id','database');

  thisdatabase = similar_record.database;
  thisid       = similar_record.id;

  thisrecord = {
      id = thisid
      database = {
             link = {
                      rel = 'self'
                      href = "${scheme}://${servername}${path_prefix}/${config.get('databases_loc')}/id/${thisdatabase}.json"
             }
             id                = thisdatabase
             description       = dbinfo.get('dbnames').${thisdatabase}.full
             description_short = dbinfo.get('dbnames').${thisdatabase}.short
             url               = dbinfo.get('urls').${thisdatabase}                          
      }
      fields = item      
  };

  similar_records_output.push(thisrecord);
END ;

metainformation = {
   ips_user    = qopts.get_option('ips_user')
};

json_output = {
    link = {
        rel = 'self'
        href = "${scheme}://${servername}${path_prefix}/${config.get('databases_loc')}/id/${database}/${config.get('titles_loc')}/id/${titleid}/similar_records.json?${cgiapp.to_cgi_querystring}"
    }

    meta    = metainformation
    records = similar_records_output
};

to_json(json_output);

-%]